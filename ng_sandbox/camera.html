<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Camera Visual Search (Cached Embeddings)</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@3.1.0/dist/mobilenet.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 1em; }
    video, canvas, img { width: 100%; max-width: 400px; }
    #status { margin: 1em 0; font-weight: bold; }
  </style>
</head>
<body>

  <h1>Visual Search</h1>
  <p id="status">Loading model…</p>

  <video id="video" autoplay playsinline></video>
  <br />
  <button id="capture-btn" disabled>Take Photo</button>

  <canvas id="canvas" style="display:none;"></canvas>

  <h2>Best Match</h2>
  <img id="result-img" />

<script>
let model;
let collectionEmbeddings = []; // { url, embedding }

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");
const resultImg = document.getElementById("result-img");
const captureBtn = document.getElementById("capture-btn");

/* ------------------ Camera ------------------ */
async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
}

/* ------------------ Model ------------------ */
async function loadModel() {
  model = await mobilenet.load({ version: 2, alpha: 1.0 });
  console.log("MobileNet loaded");
}

/* ------------------ JSON ------------------ */
async function loadCollection() {
  const res = await fetch(
    "https://johnstack.github.io/JavaScript-Sandpit/ng_sandbox/collection.sample.json"
  );
  const json = await res.json();
  return json.items; // adjust if structure differs
}

/* ------------------ Embeddings ------------------ */
async function getEmbedding(img) {
  const tensor = tf.browser.fromPixels(img)
    .resizeNearestNeighbor([224, 224])
    .toFloat()
    .expandDims();

  const embedding = model.infer(tensor, "conv_preds");
  const data = embedding.dataSync();

  tensor.dispose();
  embedding.dispose();

  return data;
}

/* ------------------ Similarity ------------------ */
function cosineSimilarity(a, b) {
  let dot = 0, magA = 0, magB = 0;
  for (let i = 0; i < a.length; i++) {
    dot += a[i] * b[i];
    magA += a[i] * a[i];
    magB += b[i] * b[i];
  }
  return dot / (Math.sqrt(magA) * Math.sqrt(magB));
}

/* ------------------ Preload Embeddings ------------------ */
async function preloadEmbeddings() {
  statusEl.textContent = "Loading image collection…";

  const items = await loadCollection();

  for (let item of items) {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = item.url; // adjust key if needed

    await new Promise(resolve => img.onload = resolve);

    const embedding = await getEmbedding(img);
    collectionEmbeddings.push({
      url: item.url,
      embedding
    });

    statusEl.textContent = `Indexed ${collectionEmbeddings.length}/${items.length}`;
  }

  statusEl.textContent = "Ready! Take a photo.";
  captureBtn.disabled = false;
}

/* ------------------ Search ------------------ */
async function findBestMatch(capturedImg) {
  const captureEmbedding = await getEmbedding(capturedImg);

  let bestScore = -1;
  let bestMatch = null;

  for (let item of collectionEmbeddings) {
    const score = cosineSimilarity(captureEmbedding, item.embedding);
    if (score > bestScore) {
      bestScore = score;
      bestMatch = item.url;
    }
  }

  return bestMatch;
}

/* ------------------ Capture ------------------ */
captureBtn.addEventListener("click", async () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  const img = new Image();
  img.src = canvas.toDataURL("image/jpeg");

  img.onload = async () => {
    statusEl.textContent = "Searching…";
    const match = await findBestMatch(img);
    resultImg.src = match;
    statusEl.textContent = "Match found!";
  };
});

/* ------------------ Init ------------------ */
(async function init() {
  await startCamera();
  await loadModel();
  await preloadEmbeddings();
})();
</script>

</body>
</html>
